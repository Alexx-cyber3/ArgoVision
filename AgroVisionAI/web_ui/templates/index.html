{% extends "layout.html" %}
{% block content %}
<!-- Stats Row -->
<div class="row g-4 mb-5">
    <div class="col-md-3">
        <div class="card p-4 h-100 border-0 bg-gradient-primary" style="background: linear-gradient(45deg, #1e1e1e, #252525);">
            <div class="d-flex justify-content-between">
                <div>
                    <small class="text-muted text-uppercase">Total Scans</small>
                    <h2 class="fw-bold text-white mt-2" id="total-scans">...</h2>
                </div>
                <div class="icon-box bg-dark p-3 rounded-circle">
                    <i class="bi bi-layers text-white"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-4 h-100 border-0" style="background: linear-gradient(45deg, #1e1e1e, #252525);">
            <div class="d-flex justify-content-between">
                <div>
                    <small class="text-muted text-uppercase">High Risk</small>
                    <h2 class="fw-bold text-danger mt-2" id="high-risk">...</h2>
                </div>
                <div class="icon-box bg-dark p-3 rounded-circle">
                    <i class="bi bi-exclamation-triangle text-danger"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-4 h-100 border-0" style="background: linear-gradient(45deg, #1e1e1e, #252525);">
            <div class="d-flex justify-content-between">
                <div>
                    <small class="text-muted text-uppercase">Avg. Confidence</small>
                    <h2 class="fw-bold text-info mt-2">94%</h2>
                </div>
                <div class="icon-box bg-dark p-3 rounded-circle">
                    <i class="bi bi-activity text-info"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <!-- Weather Widget (Real) -->
        <div class="card p-4 h-100 border-0 bg-primary text-black" style="background: var(--primary-color);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-dark fw-bold text-uppercase" id="weather-loc">Loading...</small>
                    <h2 class="fw-bold mt-2 mb-0" id="weather-temp">--°C</h2>
                    <small id="weather-desc">Fetching data...</small>
                </div>
                <i class="bi bi-cloud-sun fs-1" id="weather-icon"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4">
    <div class="col-md-8">
        <div class="card p-4 h-100">
            <h5 class="text-white mb-4">Disease Prevalence Trend</h5>
            <canvas id="diseaseChart" height="120"></canvas>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-4 h-100">
            <h5 class="text-white mb-4">Severity Breakdown</h5>
            <canvas id="severityChart" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Quick Action -->
<div class="mt-5 text-center">
    <button class="btn btn-primary btn-lg px-5 py-3 rounded-pill shadow-lg" data-bs-toggle="modal" data-bs-target="#scanModal">
        <i class="bi bi-qr-code-scan me-2"></i> Start New Diagnosis
    </button>
</div>

<script>
    // --- Real Weather Logic ---
    function fetchWeather() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                // Open-Meteo API (Free, No Key)
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('weather-temp').innerText = `${data.current_weather.temperature}°C`;
                        document.getElementById('weather-desc').innerText = `Wind: ${data.current_weather.windspeed} km/h`;
                        document.getElementById('weather-loc').innerText = "Local Field Conditions";
                    })
                    .catch(err => {
                         document.getElementById('weather-loc').innerText = "Weather Unavailable";
                    });
            });
        }
    }
    fetchWeather();

    // Fetch Stats & Render Charts
    fetch('/dashboard-stats')
        .then(res => res.json())
        .then(data => {
            // Update Number Cards
            document.getElementById('total-scans').innerText = data.total;
            document.getElementById('high-risk').innerText = data.severity_high;

            // Disease Bar Chart
            new Chart(document.getElementById('diseaseChart'), {
                type: 'bar',
                data: {
                    labels: data.disease_labels,
                    datasets: [{
                        label: 'Detections',
                        data: data.disease_data,
                        backgroundColor: '#00E676',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    }
                }
            });

            // Severity Doughnut Chart
            new Chart(document.getElementById('severityChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Low', 'Medium', 'High'],
                    datasets: [{
                        data: [data.severity_low, data.severity_medium, data.severity_high],
                        backgroundColor: ['#69f0ae', '#ffab40', '#ff5252'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } },
                    cutout: '70%'
                }
            });
        });
</script>
{% endblock %}
