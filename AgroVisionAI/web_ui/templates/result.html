{% extends "layout.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-11">
        
        <!-- Action Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="/" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i> Back to Control Center</a>
            <div class="d-flex gap-2">
                <button onclick="window.print()" class="btn btn-outline-info"><i class="bi bi-printer"></i> Export PDF</button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scanModal"><i class="bi bi-plus-lg"></i> New Analysis</button>
            </div>
        </div>

        <!-- Advanced Lab Report -->
        <div class="card p-0 overflow-hidden border-0 shadow-lg print-area" style="background: #151515;">
            <!-- Neural Header -->
            <div class="p-4 border-bottom border-secondary d-flex justify-content-between align-items-center" style="background: linear-gradient(90deg, #1a1a1a, #0d0d0d);">
                <div>
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <div class="spinner-grow spinner-grow-sm text-success" role="status"></div>
                        <h4 class="fw-bold text-white mb-0 tracking-widest" style="letter-spacing: 2px;">NEURAL CORE v4.0</h4>
                    </div>
                    <small class="text-muted text-uppercase" style="font-size: 0.65rem;">Autonomous Phytopathology Diagnostic Unit</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-dark border border-secondary text-info mb-1">SCAN_ID: {{ result.id }}</span>
                    <div class="text-muted small">{{ result.timestamp.strftime('%Y.%m.%d // %H:%M:%S') }}</div>
                </div>
            </div>

            <div class="row g-0">
                <!-- Advanced Visualizer -->
                <div class="col-md-6 position-relative bg-black d-flex align-items-center justify-content-center overflow-hidden" style="min-height: 500px;">
                    <!-- The Uploaded Image -->
                    <img src="{{ url_for('static', filename='uploads/' + result.image_path) }}" class="img-fluid" id="main-specimen" style="z-index: 1;">
                    
                    <!-- High-Tech Overlays -->
                    <div class="scanning-line"></div>
                    <div class="corner-border top-left"></div>
                    <div class="corner-border top-right"></div>
                    <div class="corner-border bottom-left"></div>
                    <div class="corner-border bottom-right"></div>
                    
                    <!-- AI Heatmap Simulation -->
                    <div class="heatmap-overlay" style="opacity: 0.4; background: radial-gradient(circle at 40% 50%, rgba(255,0,0,0.5), transparent 40%), radial-gradient(circle at 70% 30%, rgba(255,255,0,0.3), transparent 30%);"></div>
                    
                    <div class="position-absolute bottom-0 start-0 p-3 w-100 bg-gradient-to-t from-black to-transparent" style="z-index: 2;">
                        <div class="d-flex justify-content-between align-items-end">
                            <div>
                                <small class="text-info font-monospace d-block">IMAGE_RESOLUTION: 380x380px</small>
                                <small class="text-info font-monospace d-block">CHANNELS: RGB_ALPHA</small>
                            </div>
                            <div class="text-end">
                                <small class="text-success font-monospace">VISUAL_LOCK_STABLE</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Analytics -->
                <div class="col-md-6 p-4" style="border-left: 1px solid #333;">
                    <div class="mb-4">
                        <h6 class="text-muted text-uppercase small mb-3 fw-bold" style="letter-spacing: 1px;">Primary Classification</h6>
                        <h1 class="display-5 fw-bold text-white mb-1">{{ result.disease }}</h1>
                        <p class="text-info small font-monospace"><i class="bi bi-cpu"></i> INFERENCE_CONFIDENCE: {{ (result.confidence * 100)|round(2) }}%</p>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="p-3 rounded bg-dark border border-secondary">
                                <small class="text-muted d-block">Specimen Part</small>
                                <span class="fw-bold text-white fs-5">{{ result.plant_part }}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded bg-dark border border-secondary">
                                <small class="text-muted d-block">Severity Level</small>
                                <span class="fw-bold fs-5 {{ 'text-danger' if result.severity == 'High' else 'text-warning' if result.severity == 'Medium' else 'text-success' }}">
                                    {{ result.severity }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Vision Metrics (The "Advance" part) -->
                    <div class="mb-4">
                        <h6 class="text-muted text-uppercase small mb-3 fw-bold">Deep Vision Metrics</h6>
                        <div class="space-y-3">
                            <div class="mb-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-white-50">Botanical Integrity (Health)</small>
                                    <small class="text-success">{{ (metrics.get('health_score', 0.9)*100)|round(1) }}%</small>
                                </div>
                                <div class="progress bg-dark border border-secondary" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: {{ (metrics.get('health_score', 0.9)*100) }}%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-white-50">Necrosis Index (Tissue Damage)</small>
                                    <small class="text-danger">{{ (metrics.get('necrosis', 0)*100)|round(1) }}%</small>
                                </div>
                                <div class="progress bg-dark border border-secondary" style="height: 6px;">
                                    <div class="progress-bar bg-danger" style="width: {{ (metrics.get('necrosis', 0)*100) }}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-white-50">Chlorosis Index (Yellowing)</small>
                                    <small class="text-warning">{{ (metrics.get('chlorosis', 0)*100)|round(1) }}%</small>
                                </div>
                                <div class="progress bg-dark border border-secondary" style="height: 6px;">
                                    <div class="progress-bar bg-warning" style="width: {{ (metrics.get('chlorosis', 0)*100) }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Smart Auto-Prescription (The "Advance" Feature) -->
                    <div class="pt-3 border-top border-secondary">
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <i class="bi bi-prescription2 fs-4 text-primary"></i>
                            <h6 class="text-primary fw-bold text-uppercase small mb-0">Smart Auto-Prescription Protocol</h6>
                        </div>
                        
                        {% set pres = result.prescription_json|from_json %}
                        <div class="card bg-black border-secondary p-3 mb-3">
                            <div class="row g-3">
                                <div class="col-12 border-bottom border-secondary pb-2 mb-2">
                                    <small class="text-muted text-uppercase" style="font-size: 0.6rem;">Treatment Regimen</small>
                                    <div class="text-white fw-bold">{{ pres.regimen }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted text-uppercase" style="font-size: 0.6rem;">Chemical (Active)</small>
                                    <div class="text-white small">{{ pres.chemical }}</div>
                                    <div class="text-info small mt-1">{{ pres.dosage }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted text-uppercase" style="font-size: 0.6rem;">Organic Alternative</small>
                                    <div class="text-white small">{{ pres.organic }}</div>
                                    <div class="text-info small mt-1">{{ pres.frequency }}</div>
                                </div>
                                <div class="col-12 mt-2 pt-2 border-top border-secondary">
                                    <small class="text-muted text-uppercase" style="font-size: 0.6rem;">Agronomist Notes</small>
                                    <div class="text-white-50 small" style="font-style: italic;">"{{ pres.notes }}"</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-black p-3 text-center border-top border-secondary">
                <small class="text-muted font-monospace" style="font-size: 0.6rem;">
                    SYSTEM_STATUS: NOMINAL // CORE_ENGINE: EFFICIENTNET_B4 // TRUTH_VERIFICATION: ACTIVE
                </small>
            </div>
        </div>
    </div>
</div>

<style>
    .scanning-line {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 2px;
        background: rgba(0, 230, 118, 0.5);
        box-shadow: 0 0 15px #00E676;
        animation: scan 3s linear infinite;
        z-index: 3;
    }
    @keyframes scan {
        0% { top: 0; }
        100% { top: 100%; }
    }
    .heatmap-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: 2;
        pointer-events: none;
    }
    .corner-border {
        position: absolute;
        width: 30px; height: 30px;
        border: 2px solid #00E676;
        z-index: 4;
    }
    .top-left { top: 20px; left: 20px; border-right: 0; border-bottom: 0; }
    .top-right { top: 20px; right: 20px; border-left: 0; border-bottom: 0; }
    .bottom-left { bottom: 20px; left: 20px; border-right: 0; border-top: 0; }
    .bottom-right { bottom: 20px; right: 20px; border-left: 0; border-top: 0; }
    
    .tracking-widest { letter-spacing: 0.2em; }
    
    @media print {
        .sidebar, .btn, .scanning-line { display: none !important; }
        .main-content { margin-left: 0 !important; padding: 0 !important; }
        .print-area { border: 1px solid #000 !important; width: 100% !important; }
    }
</style>
{% endblock %}
